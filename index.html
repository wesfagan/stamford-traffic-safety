<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stamford Traffic Safety Explorer</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f7f6f2;
            color: #2a2a2a;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(rgba(30, 30, 30, 0.85), rgba(30, 30, 30, 0.9)),
                        url('https://images.unsplash.com/photo-1449824913935-59a10b8d2000?w=1200&q=80') center/cover no-repeat;
            color: white;
            padding: 32px 24px 24px;
            border-bottom: 1px solid #3d3d3d;
            position: relative;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
            position: relative;
            z-index: 1;
        }

        .header-text {
            flex: 1;
            min-width: 300px;
        }

        .header h1 {
            font-size: 26px;
            font-weight: 600;
            margin-bottom: 6px;
            letter-spacing: -0.3px;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
            font-weight: 400;
            line-height: 1.4;
        }

        .data-version {
            font-size: 11px;
            opacity: 0.6;
            margin-top: 6px;
        }

        .disclaimer {
            font-size: 10px;
            opacity: 0.5;
            margin-top: 8px;
            font-style: italic;
        }

        .nav {
            background: #fefefe;
            border-bottom: 1px solid #e0ddd5;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            gap: 0;
            overflow-x: auto;
        }

        .nav-item {
            padding: 18px 28px;
            background: none;
            border: none;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .nav-item:hover {
            color: #2d2d2d;
            background: #f5f4f0;
        }

        .nav-item.active {
            color: #2d2d2d;
            border-bottom-color: #4a4a4a;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        #explore-section {
            position: relative;
            height: calc(100vh - 180px);
            min-height: 600px;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* LEFT SIDEBAR - FILTER CONTROLS */
        .map-controls {
            position: absolute;
            top: 20px;
            left: 20px;
            background: #fefefe;
            border-radius: 12px;
            padding: 0;
            box-shadow: 0 2px 16px rgba(0,0,0,0.1);
            z-index: 1000;
            min-width: 300px;
            max-width: 340px;
            border: 1px solid #e8e6e0;
            max-height: calc(100vh - 220px);
            overflow-y: auto;
        }

        .controls-header {
            padding: 20px 20px 16px;
            border-bottom: 1px solid #e8e6e0;
            background: #fafaf8;
            border-radius: 12px 12px 0 0;
        }

        .controls-header h3 {
            font-size: 16px;
            font-weight: 600;
            color: #2d2d2d;
            margin-bottom: 6px;
        }

        .controls-header p {
            font-size: 12px;
            color: #666;
            line-height: 1.5;
        }

        .controls-body {
            padding: 16px 20px 20px;
        }

        .filter-section-title {
            font-size: 11px;
            font-weight: 600;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            margin-top: 20px;
        }

        .filter-section-title:first-child {
            margin-top: 0;
        }

        .control-group {
            margin-bottom: 4px;
        }

        .control-group label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            cursor: pointer;
            padding: 10px 12px;
            color: #444;
            border-radius: 6px;
            transition: background 0.15s ease;
        }

        .control-group label:hover {
            background: #f5f4f0;
        }

        .control-group input[type="checkbox"],
        .control-group input[type="radio"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: #4a4a4a;
        }

        /* Active Filters Chips */
        .active-filters-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e8e6e0;
        }

        .filter-chip {
            padding: 4px 10px;
            background: #e8f4e8;
            color: #2e7d32;
            font-size: 11px;
            font-weight: 500;
            border-radius: 12px;
            border: 1px solid #c8e6c9;
        }

        /* Filter Grid */
        .filter-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group.full-width {
            grid-column: 1 / -1;
        }

        .filter-group label {
            font-size: 12px;
            font-weight: 500;
            color: #555;
            margin-bottom: 6px;
            padding: 0;
        }

        .filter-group label:hover {
            background: transparent;
        }

        .filter-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d5d2ca;
            border-radius: 6px;
            font-size: 13px;
            background: #fefefe;
            cursor: pointer;
            transition: border-color 0.15s ease;
        }

        .filter-group select:hover {
            border-color: #999;
        }

        .filter-group select:focus {
            outline: none;
            border-color: #4a4a4a;
        }

        .reset-filters-btn {
            width: 100%;
            padding: 12px;
            border: 1px solid #c62828;
            border-radius: 6px;
            background: #fefefe;
            color: #c62828;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s ease;
            margin-top: 20px;
        }

        .reset-filters-btn:hover {
            background: #c62828;
            color: white;
        }

        .reset-filters-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            border-color: #ccc;
            color: #999;
        }

        .reset-filters-btn:disabled:hover {
            background: #fefefe;
            color: #999;
        }

        /* RIGHT SIDEBAR - HOTSPOTS */
        .map-sidebar {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 360px;
            max-height: calc(100% - 40px);
            background: #fefefe;
            border-radius: 12px;
            box-shadow: 0 2px 16px rgba(0,0,0,0.1);
            overflow: hidden;
            z-index: 1000;
            border: 1px solid #e8e6e0;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 18px 20px;
            border-bottom: 1px solid #e8e6e0;
            background: #fafaf8;
            cursor: pointer;
            transition: background 0.15s ease;
        }

        .sidebar-header:hover {
            background: #f0efe8;
        }

        .sidebar-header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-header h3 {
            font-size: 15px;
            font-weight: 600;
            color: #2d2d2d;
        }

        .sidebar-toggle-icon {
            font-size: 12px;
            color: #888;
            transition: transform 0.2s ease;
        }

        .sidebar-header.collapsed .sidebar-toggle-icon {
            transform: rotate(180deg);
        }

        .map-sidebar.collapsed {
            width: auto;
            min-width: 0;
        }

        .map-sidebar.collapsed .sidebar-sort,
        .map-sidebar.collapsed .hotspots-list,
        .map-sidebar.collapsed .sidebar-header p {
            display: none;
        }

        .map-sidebar.collapsed .sidebar-header {
            padding: 14px 18px;
        }

        .map-sidebar.collapsed .sidebar-header h3 {
            font-size: 13px;
        }

        /* Heatmap Legend */
        .heatmap-legend {
            position: absolute;
            bottom: 30px;
            right: 20px;
            background: rgba(255,255,255,0.95);
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            z-index: 1000;
            font-size: 11px;
            display: none;
        }

        .heatmap-legend.show {
            display: block;
        }

        .heatmap-legend h4 {
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .legend-scale {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .legend-gradient {
            width: 100px;
            height: 12px;
            border-radius: 2px;
            background: linear-gradient(to right, #fee5d9, #fcae91, #fb6a4a, #de2d26, #a50f15);
        }

        .legend-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 4px;
            color: #666;
            font-size: 10px;
        }

        /* Day Pills */
        .day-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .day-pill {
            padding: 6px 10px;
            background: #fefefe;
            border: 1px solid #d5d2ca;
            border-radius: 16px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            color: #555;
        }

        .day-pill:hover {
            border-color: #999;
            background: #f5f4f0;
        }

        .day-pill.active {
            background: #2d2d2d;
            color: white;
            border-color: #2d2d2d;
        }

        .day-pill-group {
            display: flex;
            gap: 4px;
            padding: 4px 8px;
            background: #f5f4f0;
            border-radius: 20px;
        }

        .sidebar-header p {
            font-size: 12px;
            color: #666;
            line-height: 1.5;
            margin-top: 6px;
        }

        .sidebar-sort {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            border-bottom: 1px solid #e8e6e0;
            background: #fefefe;
        }

        .sidebar-sort label {
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }

        .sidebar-sort select {
            flex: 1;
            padding: 8px 10px;
            border: 1px solid #d5d2ca;
            border-radius: 5px;
            font-size: 12px;
            background: #fefefe;
            cursor: pointer;
        }

        .hotspots-list {
            padding: 12px;
            overflow-y: auto;
            flex: 1;
        }

        .hotspots-list.collapsed {
            display: none;
        }

        .sidebar-sort.collapsed {
            display: none;
        }

        .hotspot-item {
            padding: 14px 16px;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            border: 1px solid #e8e6e0;
            transition: all 0.15s ease;
            background: #fefefe;
        }

        .hotspot-item:last-child {
            margin-bottom: 0;
        }

        .hotspot-item:hover {
            border-color: #999;
            background: #fafaf8;
        }

        .hotspot-item.selected {
            border-color: #4a4a4a;
            background: #f5f4f0;
        }

        .hotspot-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
        }

        .hotspot-name {
            font-weight: 500;
            color: #2d2d2d;
            font-size: 14px;
            line-height: 1.4;
            flex: 1;
        }

        .hotspot-badges {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
        }

        .fatal-indicator {
            display: inline-block;
            background: #c62828;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 9px;
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        .ped-cyclist-indicator {
            display: inline-block;
            background: #ef6c00;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 9px;
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        .hotspot-stats {
            font-size: 12px;
            color: #666;
            margin-top: 6px;
        }

        .crash-detail-panel {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e8e6e0;
        }

        .crash-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .sort-select {
            font-size: 11px;
            padding: 4px 8px;
            border: 1px solid #d5d2ca;
            border-radius: 4px;
            background: #fefefe;
            color: #444;
        }

        .toggle-crashes-btn {
            width: 100%;
            padding: 10px 14px;
            background: #f5f4f0;
            border: 1px solid #d5d2ca;
            border-radius: 6px;
            color: #444;
            font-weight: 500;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.15s ease;
        }

        .toggle-crashes-btn:hover {
            background: #eceae4;
            border-color: #999;
        }

        .crash-row {
            padding: 12px;
            margin-bottom: 8px;
            border-left: 3px solid #d5d2ca;
            background: #fafaf8;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.15s ease;
        }

        .crash-row:hover {
            background: #f0efe8;
            border-left-color: #666;
        }

        .crash-row.fatal {
            border-left-color: #c62828;
        }

        .crash-row.pedestrian,
        .crash-row.cyclist {
            border-left-color: #ef6c00;
        }

        .crash-severity {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 12px;
        }

        .crash-severity.fatal {
            color: #c62828;
        }

        .crash-severity.pedestrian,
        .crash-severity.cyclist {
            color: #ef6c00;
        }

        .crash-date {
            color: #444;
            margin-bottom: 4px;
        }

        .crash-details {
            color: #666;
            font-size: 11px;
        }

        .show-more-btn {
            width: 100%;
            padding: 10px;
            background: #fefefe;
            border: 1px solid #d5d2ca;
            border-radius: 6px;
            color: #444;
            font-weight: 500;
            cursor: pointer;
            font-size: 12px;
            margin-top: 8px;
            transition: all 0.15s ease;
        }

        .show-more-btn:hover:not(:disabled) {
            background: #f5f4f0;
            border-color: #999;
        }

        .show-more-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* CONTENT SECTIONS */
        .content-section {
            max-width: 720px;
            margin: 0 auto;
            padding: 56px 32px;
        }

        .content-section h2 {
            font-size: 30px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #2d2d2d;
            letter-spacing: -0.5px;
        }

        .content-section .subtitle {
            font-size: 16px;
            color: #666;
            margin-bottom: 32px;
            line-height: 1.5;
            font-style: italic;
        }

        .content-section .divider {
            border: none;
            border-top: 1px solid #e0ddd5;
            margin: 40px 0;
        }

        .content-section h3 {
            font-size: 22px;
            font-weight: 600;
            margin: 40px 0 16px;
            color: #2d2d2d;
            letter-spacing: -0.3px;
        }

        .content-section h3:first-of-type {
            margin-top: 0;
        }

        .content-section h4 {
            font-size: 17px;
            font-weight: 600;
            margin: 28px 0 12px;
            color: #3a3a3a;
        }

        .content-section p {
            margin-bottom: 16px;
            color: #444;
            font-size: 15px;
            line-height: 1.65;
        }

        .content-section ul,
        .content-section ol {
            margin: 16px 0 16px 24px;
        }

        .content-section li {
            margin-bottom: 10px;
            color: #444;
            font-size: 15px;
            line-height: 1.6;
        }

        .content-section table {
            width: 100%;
            border-collapse: collapse;
            margin: 28px 0;
            font-size: 14px;
        }

        .content-section th {
            background: #f5f4f0;
            padding: 14px 16px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #d5d2ca;
            color: #2d2d2d;
        }

        .content-section td {
            padding: 14px 16px;
            border-bottom: 1px solid #e8e6e0;
        }

        .content-section tr:hover {
            background: #fafaf8;
        }

        .highlight-box {
            padding: 24px;
            border-left: 4px solid #4a4a4a;
            background: #fafaf8;
            border-radius: 0 8px 8px 0;
            margin: 24px 0;
        }

        .highlight-box p {
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .highlight-box p:last-child {
            margin-bottom: 0;
        }

        .location-highlight {
            padding: 24px;
            border: 1px solid #e0ddd5;
            border-radius: 8px;
            margin: 20px 0;
            background: #fefefe;
        }

        .location-highlight h4 {
            margin-top: 0;
            margin-bottom: 6px;
        }

        .location-meta {
            font-size: 13px;
            color: #888;
            margin-bottom: 12px;
            font-weight: 500;
        }

        .footnote {
            font-size: 13px;
            color: #888;
            line-height: 1.6;
            margin-top: 40px;
            padding-top: 24px;
            border-top: 1px solid #e8e6e0;
        }

        /* LOADING & ERROR */
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 9999;
            background: #fefefe;
            padding: 36px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.12);
        }

        .spinner {
            border: 3px solid #e8e6e0;
            border-top: 3px solid #4a4a4a;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            animation: spin 1s linear infinite;
            margin: 0 auto 18px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #444;
            font-size: 14px;
        }

        .error-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fefefe;
            padding: 36px;
            border-radius: 10px;
            box-shadow: 0 4px 28px rgba(0,0,0,0.18);
            max-width: 600px;
            z-index: 10000;
            border: 2px solid #c62828;
        }

        .error-panel h3 {
            color: #c62828;
            margin-bottom: 18px;
        }

        .error-panel pre {
            background: #f5f4f0;
            padding: 14px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
            margin-top: 14px;
        }

        /* QA PANEL - hidden by default, show with ?debug=1 */
        .qa-panel {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 9000;
            transition: all 0.3s ease;
        }

        .qa-toggle-btn {
            width: 44px;
            height: 44px;
            background: #4a4a4a;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.18);
            transition: all 0.2s ease;
        }

        .qa-toggle-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 16px rgba(0,0,0,0.25);
        }

        .qa-content {
            position: absolute;
            bottom: 54px;
            left: 0;
            background: #fefefe;
            border: 1px solid #d5d2ca;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            width: 380px;
            max-height: 500px;
            display: none;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
        }

        .qa-content.show {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .qa-header {
            padding: 14px 18px;
            background: #4a4a4a;
            color: white;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .qa-header h4 {
            font-size: 13px;
            font-weight: 600;
            margin: 0;
        }

        .qa-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 20px;
            padding: 0;
            width: 26px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .qa-close:hover {
            opacity: 0.7;
        }

        .qa-body {
            padding: 18px;
            max-height: 350px;
            overflow-y: auto;
            font-size: 13px;
        }

        .qa-test {
            padding: 10px 0;
            border-bottom: 1px solid #e8e6e0;
        }

        .qa-test:last-child {
            border-bottom: none;
        }

        .qa-test.pass::before {
            content: "\2713 ";
            color: #2e7d32;
            font-weight: bold;
        }

        .qa-test.fail::before {
            content: "\2717 ";
            color: #c62828;
            font-weight: bold;
        }

        .qa-actions {
            padding: 14px 18px;
            border-top: 1px solid #e8e6e0;
            display: flex;
            gap: 10px;
        }

        .qa-actions button {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid #d5d2ca;
            border-radius: 6px;
            background: #fefefe;
            cursor: pointer;
            font-size: 12px;
        }

        .qa-actions button:hover {
            background: #f5f4f0;
        }

        /* RESPONSIVE */
        /* Heatmap tooltip */
        .heatmap-tooltip {
            background: rgba(255,255,255,0.95);
            border: 1px solid #d5d2ca;
            border-radius: 6px;
            padding: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .heatmap-tooltip .leaflet-tooltip-content {
            margin: 0;
        }

        @media (max-width: 768px) {
            .header {
                padding: 16px 16px 12px;
                background-size: cover;
            }

            .header h1 {
                font-size: 18px;
            }

            .header p {
                font-size: 12px;
                display: none;
            }

            .disclaimer {
                font-size: 9px;
                margin-top: 4px;
            }

            .nav-item {
                padding: 12px 16px;
                font-size: 13px;
            }

            /* Map takes full viewport on mobile */
            #explore-section {
                height: calc(100vh - 100px);
                min-height: 400px;
                position: relative;
            }

            #map {
                height: 100%;
                width: 100%;
            }

            /* Filters as compact bottom sheet */
            .map-controls {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                top: auto;
                max-width: none;
                width: 100%;
                border-radius: 16px 16px 0 0;
                max-height: 60vh;
                overflow-y: auto;
                z-index: 1001;
                transform: translateY(calc(100% - 60px));
                transition: transform 0.3s ease;
            }

            .map-controls.expanded {
                transform: translateY(0);
            }

            .map-controls .controls-header {
                cursor: pointer;
                position: sticky;
                top: 0;
                z-index: 10;
            }

            .map-controls .controls-header::after {
                content: '⌃ Filters';
                display: block;
                text-align: center;
                font-size: 11px;
                color: #888;
                margin-top: 4px;
            }

            .map-controls.expanded .controls-header::after {
                content: '⌄ Close';
            }

            /* Hotspots as compact collapsed panel */
            .map-sidebar {
                position: fixed;
                top: auto;
                bottom: 70px;
                right: 10px;
                left: auto;
                width: auto;
                max-width: 200px;
                max-height: 50vh;
                border-radius: 10px;
            }

            .map-sidebar.collapsed {
                max-width: 160px;
            }

            .map-sidebar .sidebar-header h3 {
                font-size: 12px;
            }

            /* Heatmap legend repositioned */
            .heatmap-legend {
                bottom: 80px;
                right: 10px;
                left: auto;
            }

            .heatmap-legend.show {
                display: block;
            }

            .content-section {
                padding: 32px 16px;
            }

            .content-section h2 {
                font-size: 22px;
            }

            .content-section h3 {
                font-size: 17px;
                margin: 28px 0 12px;
            }

            .filter-grid {
                grid-template-columns: 1fr;
            }

            .qa-panel {
                bottom: 10px;
                left: 10px;
            }

            .qa-content {
                width: calc(100vw - 60px);
                max-width: 350px;
            }
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div class="loading-text">Loading crash data...</div>
    </div>

    <div class="header">
        <div class="header-content">
            <div class="header-text">
                <h1>Stamford Traffic Safety Explorer</h1>
                <p>Crash data across Stamford, mapped.</p>
                <div class="data-version" id="dataVersion">Loading...</div>
                <div class="disclaimer">Unofficial. Not affiliated with the City of Stamford.</div>
            </div>
        </div>
    </div>

    <div class="nav">
        <div class="nav-content" id="navContent">
            <button class="nav-item active" data-section="explore">Explore Map</button>
            <button class="nav-item" data-section="analysis">Analysis</button>
            <button class="nav-item" data-section="methodology">Methodology</button>
            <button class="nav-item" data-section="about">About</button>
        </div>
    </div>

    <div class="section active" id="explore-section">
        <!-- LEFT SIDEBAR - FILTERS -->
        <div class="map-controls">
            <div class="controls-header">
                <h3>Filter Crashes</h3>
                <p>Showing injury and fatal crashes from the last five years. Property-damage-only crashes are excluded.</p>
            </div>

            <div class="controls-body">
                <!-- Active Filters Chips -->
                <div class="active-filters-chips" id="activeFiltersChips" style="display: none;"></div>

                <!-- Crash Type Radio Buttons -->
                <div class="filter-section-title">Crash Type</div>
                <div class="control-group">
                    <label>
                        <input type="radio" name="crashFilter" value="all" checked>
                        All safety-priority crashes
                    </label>
                    <label>
                        <input type="radio" name="crashFilter" value="pedestrian">
                        Pedestrian/cyclist only
                    </label>
                    <label>
                        <input type="radio" name="crashFilter" value="fatal">
                        Fatal crashes only
                    </label>
                </div>

                <!-- Filter Dropdowns in Grid -->
                <div class="filter-section-title">Refine Results</div>
                <div class="filter-grid">
                    <div class="filter-group">
                        <label>Year</label>
                        <select id="yearFilter" onchange="applyFilters()">
                            <option value="all">All Years</option>
                            <option value="2025">2025</option>
                            <option value="2024">2024</option>
                            <option value="2023">2023</option>
                            <option value="2022">2022</option>
                            <option value="2021">2021</option>
                        </select>
                    </div>

                    <div class="filter-group full-width">
                        <label>Day of Week</label>
                        <div class="day-pills" id="dayPills">
                            <span class="day-pill active" data-day="all">All</span>
                            <span class="day-pill" data-day="weekday">Weekdays</span>
                            <span class="day-pill" data-day="weekend">Weekends</span>
                            <span class="day-pill" data-day="mon">Mon</span>
                            <span class="day-pill" data-day="tue">Tue</span>
                            <span class="day-pill" data-day="wed">Wed</span>
                            <span class="day-pill" data-day="thu">Thu</span>
                            <span class="day-pill" data-day="fri">Fri</span>
                            <span class="day-pill" data-day="sat">Sat</span>
                            <span class="day-pill" data-day="sun">Sun</span>
                        </div>
                    </div>

                    <div class="filter-group">
                        <label>Time of Day</label>
                        <select id="timeFilter" onchange="applyFilters()">
                            <option value="all">All Times</option>
                            <option value="morning">Morning (6-9am)</option>
                            <option value="midday">Midday (9am-3pm)</option>
                            <option value="afternoon">Afternoon (3-6pm)</option>
                            <option value="evening">Evening (6-9pm)</option>
                            <option value="night">Night (9pm-6am)</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label>Lighting</label>
                        <select id="lightingFilter" onchange="applyFilters()">
                            <option value="all">All Conditions</option>
                            <option value="daylight">Daylight</option>
                            <option value="dark">Dark</option>
                            <option value="dusk">Dusk/Dawn</option>
                        </select>
                    </div>

                    <div class="filter-group full-width">
                        <label>Weather</label>
                        <select id="weatherFilter" onchange="applyFilters()">
                            <option value="all">All Weather</option>
                            <option value="clear">Clear</option>
                            <option value="rain">Rain</option>
                            <option value="snow">Snow/Ice</option>
                        </select>
                    </div>
                </div>

                <!-- Display Toggle -->
                <div class="filter-section-title">Display</div>
                <div class="control-group">
                    <label>
                        <input type="checkbox" id="showHeatmap">
                        Show density overlay
                    </label>
                </div>

                <!-- Reset Button -->
                <button class="reset-filters-btn" id="resetFiltersBtn" onclick="resetFilters()" disabled>
                    Reset All Filters
                </button>
            </div>
        </div>

        <!-- RIGHT SIDEBAR - HOTSPOTS -->
        <div class="map-sidebar collapsed" id="mapSidebar">
            <div class="sidebar-header" id="sidebarHeader" onclick="toggleHotspotsList()">
                <div class="sidebar-header-top">
                    <h3>High-Risk Locations</h3>
                    <span class="sidebar-toggle-icon" id="sidebarToggleIcon">&#9660;</span>
                </div>
                <p>Locations ranked by crash frequency and severity.</p>
            </div>
            <div class="sidebar-sort" id="sidebarSort">
                <label>Sort:</label>
                <select id="hotspotSortSelect" onchange="sortHotspots()">
                    <option value="score">Risk Score</option>
                    <option value="crashes">Most Crashes</option>
                    <option value="fatal">Fatalities</option>
                    <option value="ped">Ped/Cyclist</option>
                </select>
            </div>
            <div class="hotspots-list" id="hotspotsList"></div>
        </div>

        <!-- Heatmap Legend -->
        <div class="heatmap-legend" id="heatmapLegend">
            <h4>Crash Density</h4>
            <div class="legend-gradient"></div>
            <div class="legend-labels">
                <span>Low</span>
                <span>High</span>
            </div>
        </div>

        <div id="map"></div>
    </div>

    <div class="section" id="analysis-section">
        <div class="content-section">
            <h2>Crash Patterns</h2>
            <p class="subtitle">A look at where and when injury and fatal crashes happen in Stamford.</p>

            <div class="divider"></div>

            <h3>Pedestrian and Cyclist Crashes</h3>
            <p>Over the last five years, 310 crashes involved people walking or cycling. These represent 13% of all injury and fatal crashes, but account for 39% of fatalities.</p>
            <p>Nine pedestrians or cyclists were killed during this period. Total fatalities across all crash types: 23.</p>

            <div class="highlight-box">
                <p><strong>Bedford Street:</strong> 7 pedestrian or cyclist crashes, 1 fatal</p>
                <p><strong>Broad Street:</strong> 7 pedestrian or cyclist crashes</p>
                <p><strong>Elm Street:</strong> 4 pedestrian or cyclist crashes</p>
                <p><strong>Jefferson Street:</strong> 4 pedestrian or cyclist crashes</p>
            </div>

            <p>These locations see repeated pedestrian and cyclist crashes, suggesting they may warrant closer attention from transportation planners.</p>

            <h3>High-Crash Locations</h3>
            <p>Crashes tend to cluster at certain locations. Here are some of the areas with the highest crash counts:</p>

            <div class="location-highlight">
                <h4>North State Street (Route 1)</h4>
                <p class="location-meta">34 injury crashes</p>
                <p>High traffic corridor with consistent crash activity. Multiple lanes, commercial driveways, and pedestrian crossings.</p>
            </div>

            <div class="location-highlight">
                <h4>I-95 South (Exit 8 area)</h4>
                <p class="location-meta">22 injury crashes, 1 fatal</p>
                <p>Highway exit area with high vehicle speeds merging onto local roads.</p>
            </div>

            <div class="location-highlight">
                <h4>Route 137 North</h4>
                <p class="location-meta">17 injury crashes, 3 pedestrian/cyclist</p>
                <p>Suburban corridor with limited pedestrian infrastructure in some sections.</p>
            </div>

            <div class="location-highlight">
                <h4>Broad Street (Downtown)</h4>
                <p class="location-meta">16 injury crashes, 7 pedestrian/cyclist</p>
                <p>Downtown area with high pedestrian and vehicle activity. Nearly half of crashes here involve pedestrians or cyclists.</p>
            </div>

            <h3>When Crashes Happen</h3>
            <p>Serious crashes concentrate during predictable times:</p>
            <ul>
                <li><strong>5:00 PM:</strong> Evening rush. High traffic, driver fatigue, fading light.</li>
                <li><strong>8:00 AM:</strong> Morning commute. Speed, impatience, school traffic.</li>
                <li><strong>3:00 PM:</strong> School dismissal. Children crossing streets, distracted drivers.</li>
                <li><strong>Dark conditions:</strong> Insufficient lighting at key crossings amplifies every other risk.</li>
            </ul>
            <p>These patterns suggest where targeted enforcement, signal timing adjustments, and lighting improvements could reduce harm.</p>

            <h3>Using This Data</h3>
            <p>Crash data can help identify areas that may benefit from infrastructure review. Factors like road design, signal timing, lighting, and crosswalk placement all play a role in crash patterns.</p>
            <p>The city's Vision Zero program uses data like this to prioritize safety improvements across Stamford.</p>

            <div class="divider"></div>

            <h3>Crash Severity Classifications</h3>
            <table>
                <thead>
                    <tr>
                        <th>Classification</th>
                        <th>Count</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Fatal</strong></td>
                        <td>23</td>
                        <td>Crashes resulting in at least one death</td>
                    </tr>
                    <tr>
                        <td><strong>Injury</strong></td>
                        <td>2,346</td>
                        <td>Crashes with reported injuries requiring medical attention</td>
                    </tr>
                    <tr style="opacity: 0.5;">
                        <td>Property damage only</td>
                        <td>8,550</td>
                        <td>Minor crashes (fender benders) with no reported injuries</td>
                    </tr>
                </tbody>
            </table>

            <p class="footnote">This tool focuses on injury and fatal crashes. Property-damage-only crashes are excluded since they typically represent minor incidents like parking lot fender benders.</p>
        </div>
    </div>

    <div class="section" id="methodology-section">
        <div class="content-section">
            <h2>How This Analysis Works</h2>
            <p class="subtitle">Data sources, analytical methods, and important limitations.</p>

            <div class="divider"></div>

            <h3>Data Source</h3>
            <p>All crash data comes from the Connecticut Crash Data Repository, maintained by the UConn Transportation Safety Research Center. This includes 2,369 injury and fatal crashes in Stamford over the last five years.</p>
            <p>Every crash is police-reported, geocoded with latitude and longitude coordinates, and validated by Connecticut DOT. This is not a sample. This is the complete official record.</p>

            <h3>What Gets Included</h3>
            <p>This analysis focuses exclusively on crashes where someone was hurt or killed:</p>
            <ul>
                <li>Fatal crashes (23 total)</li>
                <li>Injury crashes requiring medical attention (2,346 total)</li>
                <li>Any crash involving a pedestrian or cyclist, regardless of injury severity</li>
            </ul>
            <p>Property-damage-only crashes are excluded. This is intentional. Most property-damage crashes are minor parking lot incidents that don't indicate dangerous street design. Including them would obscure the locations where people are actually at risk.</p>

            <h3>How Hotspots Are Identified</h3>
            <p>Crashes are grouped into geographic clusters using a grid system of approximately 100 meters per cell. Locations are then ranked by a severity-weighted score:</p>
            <ul>
                <li>Fatal crash: 20 points</li>
                <li>Injury crash: 5 points</li>
                <li>Pedestrian or cyclist involvement: additional weight</li>
            </ul>
            <p>This scoring prioritizes locations where the most severe outcomes occur, not just where the most crashes happen.</p>

            <h3>Matching Crashes to Locations</h3>
            <p>When you click a hotspot, the tool finds related crashes using two methods:</p>
            <ul>
                <li><strong>Geographic proximity:</strong> Crashes within 150 meters of the hotspot center</li>
                <li><strong>Road name matching:</strong> Crashes whose location string contains the hotspot road name</li>
            </ul>
            <p>This dual approach accounts for imprecise geocoding and ensures you see the full picture at each location.</p>

            <h3>Important Limitations</h3>
            <p><strong>No exposure normalization:</strong> This analysis shows raw crash counts, not crash rates per mile traveled. A road with high traffic will naturally show more crashes than a quiet residential street, even if the quiet street is more dangerous per trip. Rate-based analysis would require traffic volume data, which is not included here.</p>
            <p><strong>Incomplete environmental data:</strong> Some crashes lack complete details about weather, lighting, or road conditions. These gaps are noted in the data.</p>
            <p><strong>Reporting lag:</strong> Fatal crash reports can take months to finalize during investigation. The most recent crashes may not yet be fully documented.</p>
            <p><strong>Not an engineering study:</strong> This analysis identifies priorities and patterns. It is not a substitute for detailed engineering evaluation before implementing infrastructure changes.</p>

            <h3>Technical Implementation</h3>
            <p>This tool is built using Leaflet.js for mapping and vanilla JavaScript for interactivity. Data is loaded from external JSON files, making it easy to update without modifying the code. The tool works on any static web host.</p>

            <div class="divider"></div>

            <p class="footnote">Questions about methodology or data quality can be directed to the Connecticut Crash Data Repository at UConn. This is an independent analysis using publicly available data.</p>
        </div>
    </div>

    <div class="section" id="about-section">
        <div class="content-section">
            <h2>About This Tool</h2>
            <p class="subtitle">A map of Stamford crash data to help residents stay informed.</p>

            <div class="divider"></div>

            <h3>What This Is</h3>
            <p>This is a map of reported injury and fatal crashes in Stamford over the past five years. The data comes from police reports filed with the state. It's meant to give residents a clear picture of where crashes tend to happen across the city.</p>
            <p>You can filter by year, time of day, weather, and other factors to see how patterns shift. The density overlay shows which areas have higher crash concentrations.</p>

            <h3>Staying Safe</h3>
            <p>A few practical reminders when you're out and about:</p>
            <ul>
                <li>Walk like cars may not yield, even in crosswalks</li>
                <li>Look both ways, even on a walk signal</li>
                <li>Be extra cautious at night and in rain</li>
                <li>Report recurring hazards (broken signals, poor lighting) to 311</li>
            </ul>

            <h3>Stamford's Vision Zero Program</h3>
            <p>Stamford adopted Vision Zero in 2022, joining cities nationwide working to reduce traffic deaths. The city has been making improvements to streets, signals, and crosswalks as part of this effort. This tool is meant to complement that work by making crash data more accessible to residents.</p>

            <div class="highlight-box">
                <p><strong>Official City Resources:</strong></p>
                <p><a href="https://www.stamfordct.gov/government/operations/traffic-parking" style="color: #2e7d32;">Traffic & Parking Department</a></p>
                <p><a href="https://www.stamfordct.gov/home/showpublisheddocument/8196" style="color: #2e7d32;">Vision Zero Action Plan (PDF)</a></p>
                <p><a href="https://www.stamfordct.gov/government/operations/traffic-parking/vision-zero" style="color: #2e7d32;">Vision Zero Program Page</a></p>
            </div>

            <h3>Share This Tool</h3>
            <p>If you find this useful, feel free to share it.</p>
            <p><strong>Link:</strong> <a href="https://wesfagan.github.io/stamford-traffic-safety/" style="color: #2e7d32;">wesfagan.github.io/stamford-traffic-safety</a></p>

            <div class="divider"></div>

            <p class="footnote">This is an independent project using publicly available data from the Connecticut Crash Data Repository. It is not affiliated with the City of Stamford.</p>
        </div>
    </div>

    <div class="qa-panel" id="qaPanel">
        <button class="qa-toggle-btn" onclick="toggleQAPanel()" title="QA / Diagnostics">
            &#128295;
        </button>
        <div class="qa-content" id="qaContent">
            <div class="qa-header">
                <h4>QA / Diagnostics</h4>
                <button class="qa-close" onclick="toggleQAPanel()">&times;</button>
            </div>
            <div class="qa-body" id="qaBody">
                <div style="margin-bottom: 12px; font-size: 12px; color: #666;">
                    <strong>Version:</strong> <span id="qaVersion">Loading...</span><br>
                    <strong>Loaded:</strong> <span id="qaTimestamp"></span>
                </div>
                <div id="qaTests"></div>
            </div>
            <div class="qa-actions">
                <button onclick="runSmokeTests()">Run Tests</button>
                <button onclick="copyDiagnostics()">Copy Results</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <script>
        // Debug mode detection
        const isDebugMode = new URLSearchParams(window.location.search).has('debug');
        if (isDebugMode) {
            document.getElementById('qaPanel').style.display = 'block';
        }

        // Global data containers
        let crashData = [];
        let hotspotData = [];
        let metaData = {};
        let sortedHotspotData = [];

        let map;
        let crashMarkers = [];
        let crashMarkersIndex = {};
        let heatmapLayer;
        let currentFilter = 'all';
        let activeFilters = {
            crashType: 'all',
            year: 'all',
            time: 'all',
            day: 'all',
            lighting: 'all',
            weather: 'all'
        };
        let highlightCircle = null;
        let currentSelectedHotspot = null;
        let currentCrashLists = {};
        let testResults = {};
        let tilesLoaded = false;
        let hotspotsExpanded = false;

        // Data loading with cache-busting
        async function loadData() {
            try {
                const metaResponse = await fetch('data/meta.json');
                if (!metaResponse.ok) throw new Error('Failed to load meta.json');
                metaData = await metaResponse.json();

                const cacheKey = metaData.cacheKey || Date.now();

                const crashResponse = await fetch(`data/crashes.json?v=${cacheKey}`);
                if (!crashResponse.ok) throw new Error('Failed to load crashes.json');
                crashData = await crashResponse.json();

                const hotspotResponse = await fetch(`data/hotspots.json?v=${cacheKey}`);
                if (!hotspotResponse.ok) throw new Error('Failed to load hotspots.json');
                hotspotData = await hotspotResponse.json();
                sortedHotspotData = [...hotspotData];

                const versionEl = document.getElementById('dataVersion');
                if (versionEl) {
                    versionEl.textContent = 'Data: 2026';
                }

                const qaVersionEl = document.getElementById('qaVersion');
                if (qaVersionEl) {
                    qaVersionEl.textContent = metaData.version || '2.5';
                }

                return true;
            } catch (error) {
                console.error('Data loading error:', error);
                throw error;
            }
        }

        function showError(stage, error) {
            const loadingEl = document.getElementById('loading');
            if (loadingEl) loadingEl.style.display = 'none';

            const errorPanel = document.createElement('div');
            errorPanel.className = 'error-panel';
            errorPanel.innerHTML = `
                <h3>Initialization Error</h3>
                <p><strong>Stage:</strong> ${stage}</p>
                <p><strong>Message:</strong> ${error.message}</p>
                <pre>${error.stack || 'No stack trace available'}</pre>
            `;
            document.body.appendChild(errorPanel);
        }

        function hideLoading() {
            const loadingEl = document.getElementById('loading');
            if (loadingEl) loadingEl.style.display = 'none';
        }

        function validateData() {
            const errors = [];
            if (!Array.isArray(crashData)) {
                errors.push('crashData is not an array');
            }
            if (!Array.isArray(hotspotData)) {
                errors.push('hotspotData is not an array');
            }
            return errors;
        }

        function buildCrashIndex() {
            crashData.forEach((crash, idx) => {
                const id = `crash_${idx}`;
                crash.id = id;
                crashMarkersIndex[id] = crash;
            });
        }

        function initializeMap() {
            map = L.map('map').setView([41.0534, -73.5387], 12);

            const tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors',
                maxZoom: 19
            });

            tileLayer.on('load', () => { tilesLoaded = true; });
            tileLayer.addTo(map);
        }

        function setupNavigation() {
            const navContent = document.getElementById('navContent');
            if (!navContent) return;

            navContent.addEventListener('click', (e) => {
                const navItem = e.target.closest('.nav-item');
                if (!navItem) return;

                const sectionId = navItem.getAttribute('data-section') + '-section';
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                navItem.classList.add('active');
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));

                const targetSection = document.getElementById(sectionId);
                if (targetSection) {
                    targetSection.classList.add('active');
                    if (sectionId === 'explore-section' && map) {
                        setTimeout(() => map.invalidateSize(), 100);
                    }
                }
            });
        }

        function setupControls() {
            // Mobile filter panel toggle
            const controlsHeader = document.querySelector('.map-controls .controls-header');
            const mapControls = document.querySelector('.map-controls');
            if (controlsHeader && mapControls) {
                controlsHeader.addEventListener('click', (e) => {
                    if (window.innerWidth <= 768) {
                        mapControls.classList.toggle('expanded');
                    }
                });
            }

            const heatmapCheckbox = document.getElementById('showHeatmap');
            if (heatmapCheckbox) {
                heatmapCheckbox.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        showHeatmap();
                    } else {
                        hideHeatmap();
                    }
                });
            }

            document.querySelectorAll('input[name="crashFilter"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    currentFilter = e.target.value;
                    activeFilters.crashType = e.target.value;
                    filterCrashes(currentFilter);
                    if (document.getElementById('showHeatmap').checked) {
                        hideHeatmap();
                        showHeatmap();
                    }
                    updateFilterCount();
                });
            });

            // Day pill click handlers
            document.querySelectorAll('.day-pill').forEach(pill => {
                pill.addEventListener('click', () => {
                    document.querySelectorAll('.day-pill').forEach(p => p.classList.remove('active'));
                    pill.classList.add('active');
                    activeFilters.day = pill.getAttribute('data-day');
                    applyFilters();
                });
            });

            updateFilterCount();
        }

        // Filter matching functions
        function matchesYearFilter(crash) {
            if (activeFilters.year === 'all') return true;
            if (!crash.date) return false;
            const year = crash.date.substring(0, 4);
            return year === activeFilters.year;
        }

        function matchesTimeFilter(crash) {
            if (activeFilters.time === 'all') return true;
            if (!crash.time) return false;
            const timeParts = crash.time.split(':');
            if (timeParts.length < 2) return false;
            const hour = parseInt(timeParts[0], 10);
            if (isNaN(hour)) return false;

            switch(activeFilters.time) {
                case 'morning': return hour >= 6 && hour < 9;
                case 'midday': return hour >= 9 && hour < 15;
                case 'afternoon': return hour >= 15 && hour < 18;
                case 'evening': return hour >= 18 && hour < 21;
                case 'night': return hour >= 21 || hour < 6;
                default: return true;
            }
        }

        function matchesDayFilter(crash) {
            if (activeFilters.day === 'all') return true;
            if (!crash.date) return false;
            const dateParts = crash.date.split('-');
            if (dateParts.length !== 3) return false;
            const year = parseInt(dateParts[0], 10);
            const month = parseInt(dateParts[1], 10) - 1;
            const day = parseInt(dateParts[2], 10);
            if (isNaN(year) || isNaN(month) || isNaN(day)) return false;
            const date = new Date(year, month, day);
            if (isNaN(date.getTime())) return false;
            const dayOfWeek = date.getDay(); // 0=Sun, 1=Mon, ... 6=Sat

            const dayMap = { sun: 0, mon: 1, tue: 2, wed: 3, thu: 4, fri: 5, sat: 6 };

            switch(activeFilters.day) {
                case 'weekday': return dayOfWeek >= 1 && dayOfWeek <= 5;
                case 'weekend': return dayOfWeek === 0 || dayOfWeek === 6;
                case 'sun': case 'mon': case 'tue': case 'wed': case 'thu': case 'fri': case 'sat':
                    return dayOfWeek === dayMap[activeFilters.day];
                default: return true;
            }
        }

        function matchesLightingFilter(crash) {
            if (activeFilters.lighting === 'all') return true;
            if (!crash.light) return false;
            const light = crash.light.toLowerCase();
            switch(activeFilters.lighting) {
                case 'daylight': return light.includes('daylight') || light.includes('day');
                case 'dark': return light.includes('dark') && !light.includes('dawn') && !light.includes('dusk');
                case 'dusk': return light.includes('dawn') || light.includes('dusk');
                default: return true;
            }
        }

        function matchesWeatherFilter(crash) {
            if (activeFilters.weather === 'all') return true;
            if (!crash.weather) return false;
            const weather = crash.weather.toLowerCase();
            switch(activeFilters.weather) {
                case 'clear': return weather.includes('clear') || weather.includes('cloudy');
                case 'rain': return weather.includes('rain');
                case 'snow': return weather.includes('snow') || weather.includes('ice') || weather.includes('sleet') || weather.includes('freez');
                default: return true;
            }
        }

        function getFilteredCrashes() {
            let filtered = crashData;

            if (activeFilters.crashType === 'fatal') {
                filtered = filtered.filter(crash => crash.severity === 'fatal');
            } else if (activeFilters.crashType === 'pedestrian') {
                filtered = filtered.filter(crash =>
                    crash.type === 'pedestrian' || crash.type === 'cyclist'
                );
            }

            filtered = filtered.filter(crash =>
                matchesYearFilter(crash) &&
                matchesTimeFilter(crash) &&
                matchesDayFilter(crash) &&
                matchesLightingFilter(crash) &&
                matchesWeatherFilter(crash)
            );

            return filtered;
        }

        function filterCrashes(filterType) {
            crashMarkers.forEach(marker => map.removeLayer(marker));
            crashMarkers = [];

            const filteredCrashes = getFilteredCrashes();

            filteredCrashes.forEach(crash => {
                const color = getMarkerColor(crash);
                const marker = L.circleMarker([crash.lat, crash.lng], {
                    radius: crash.severity === 'fatal' ? 8 : crash.type === 'pedestrian' || crash.type === 'cyclist' ? 6 : 5,
                    fillColor: color,
                    color: '#fff',
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                });

                marker.crashId = String(crash.id);

                const popupContent = `
                    <div style="font-family: system-ui; font-size: 13px; min-width: 200px;">
                        <strong style="color: ${color}; font-size: 14px; display: block; margin-bottom: 8px;">
                            ${crash.severity.toUpperCase()}${crash.type !== 'vehicle' ? ' - ' + crash.type.toUpperCase() : ''}
                        </strong>
                        <div style="margin-bottom: 4px;"><strong>Location:</strong> ${crash.location}</div>
                        <div style="margin-bottom: 4px;"><strong>Date:</strong> ${crash.date}</div>
                        <div style="margin-bottom: 4px;"><strong>Time:</strong> ${crash.time}</div>
                        <div style="margin-bottom: 4px;"><strong>Weather:</strong> ${crash.weather}</div>
                        <div><strong>Light:</strong> ${crash.light}</div>
                    </div>
                `;

                marker.bindPopup(popupContent);
                marker.addTo(map);
                crashMarkers.push(marker);
            });
        }

        function getMarkerColor(crash) {
            if (crash.severity === 'fatal') return '#c62828';
            if (crash.type === 'pedestrian' || crash.type === 'cyclist') return '#ef6c00';
            return '#666';
        }

        let heatmapGridData = {}; // Store grid data for hover tooltips
        let hoverLayer = null; // Invisible grid for hover tooltips

        function showHeatmap() {
            // Remove existing layers
            if (heatmapLayer) map.removeLayer(heatmapLayer);
            if (hoverLayer) map.removeLayer(hoverLayer);

            const filteredCrashes = getFilteredCrashes();

            // Hide crash markers when heatmap is on
            crashMarkers.forEach(marker => marker.setStyle({ opacity: 0, fillOpacity: 0 }));

            // Build grid for hover tooltips
            const gridSize = 0.003; // ~300m cells for hover zones
            heatmapGridData = {};

            filteredCrashes.forEach(crash => {
                const gridX = Math.floor(crash.lng / gridSize);
                const gridY = Math.floor(crash.lat / gridSize);
                const key = `${gridX},${gridY}`;

                if (!heatmapGridData[key]) {
                    heatmapGridData[key] = {
                        count: 0, fatal: 0, injury: 0,
                        lat: 0, lng: 0
                    };
                }

                heatmapGridData[key].count++;
                heatmapGridData[key].lat += crash.lat;
                heatmapGridData[key].lng += crash.lng;
                if (crash.severity === 'fatal') heatmapGridData[key].fatal++;
                else heatmapGridData[key].injury++;
            });

            // Percentile-based normalization (95th percentile as max)
            const counts = Object.values(heatmapGridData).map(g => g.count).sort((a, b) => a - b);
            const p95Index = Math.floor(counts.length * 0.95);
            const normMax = counts[p95Index] || counts[counts.length - 1] || 1;

            // Build heatmap data points: [lat, lng, intensity]
            const heatPoints = filteredCrashes.map(crash => {
                // Weight by severity
                const weight = crash.severity === 'fatal' ? 1.0 :
                              (crash.type === 'pedestrian' || crash.type === 'cyclist') ? 0.7 : 0.5;
                return [crash.lat, crash.lng, weight];
            });

            // Create canvas heatmap with Leaflet.heat
            heatmapLayer = L.heatLayer(heatPoints, {
                radius: 25,        // Base radius in pixels
                blur: 20,          // Blur for smooth blending
                maxZoom: 17,       // Max zoom level for scaling
                max: 1.0,          // Max intensity value
                minOpacity: 0.3,   // Minimum opacity
                gradient: {        // Color gradient (compressed low values, hotspots hit red)
                    0.0: '#fff5f0',
                    0.2: '#fee0d2',
                    0.35: '#fcbba1',
                    0.5: '#fc9272',
                    0.65: '#fb6a4a',
                    0.8: '#de2d26',
                    1.0: '#a50f15'
                }
            });

            heatmapLayer.addTo(map);

            // Create invisible hover layer for tooltips
            hoverLayer = L.layerGroup();

            Object.entries(heatmapGridData).forEach(([key, cell]) => {
                const centerLat = cell.lat / cell.count;
                const centerLng = cell.lng / cell.count;

                const hoverZone = L.circle([centerLat, centerLng], {
                    radius: 200,
                    fillColor: 'transparent',
                    fillOpacity: 0,
                    stroke: false,
                    interactive: true
                });

                hoverZone.bindTooltip(`
                    <div style="font-size: 12px; line-height: 1.4;">
                        <strong>${cell.count} crashes</strong><br>
                        ${cell.fatal > 0 ? `<span style="color: #c62828;">${cell.fatal} fatal</span><br>` : ''}
                        ${cell.injury} injury
                    </div>
                `, { sticky: true, className: 'heatmap-tooltip' });

                hoverLayer.addLayer(hoverZone);
            });

            hoverLayer.addTo(map);

            // Show legend
            document.getElementById('heatmapLegend').classList.add('show');
        }

        function hideHeatmap() {
            if (heatmapLayer) map.removeLayer(heatmapLayer);
            if (hoverLayer) map.removeLayer(hoverLayer);
            document.getElementById('heatmapLegend').classList.remove('show');

            // Show crash markers again
            crashMarkers.forEach(marker => marker.setStyle({ opacity: 1, fillOpacity: 0.8 }));
        }

        function applyFilters() {
            activeFilters.year = document.getElementById('yearFilter').value;
            activeFilters.time = document.getElementById('timeFilter').value;
            // day is set via pill click, not select
            activeFilters.lighting = document.getElementById('lightingFilter').value;
            activeFilters.weather = document.getElementById('weatherFilter').value;

            filterCrashes(activeFilters.crashType);

            if (document.getElementById('showHeatmap').checked) {
                hideHeatmap();
                showHeatmap();
            }

            updateFilterCount();
        }

        function resetFilters() {
            activeFilters = {
                crashType: 'all',
                year: 'all',
                time: 'all',
                day: 'all',
                lighting: 'all',
                weather: 'all'
            };

            document.querySelector('input[name="crashFilter"][value="all"]').checked = true;
            document.getElementById('yearFilter').value = 'all';
            document.getElementById('timeFilter').value = 'all';
            // Reset day pills
            document.querySelectorAll('.day-pill').forEach(p => p.classList.remove('active'));
            document.querySelector('.day-pill[data-day="all"]').classList.add('active');
            document.getElementById('lightingFilter').value = 'all';
            document.getElementById('weatherFilter').value = 'all';

            filterCrashes('all');

            if (document.getElementById('showHeatmap').checked) {
                hideHeatmap();
                showHeatmap();
            }

            updateFilterCount();
        }

        function updateFilterCount() {
            const activeCount = Object.values(activeFilters).filter(val => val !== 'all').length;
            const activeFiltersChips = document.getElementById('activeFiltersChips');
            const resetBtn = document.getElementById('resetFiltersBtn');

            if (!activeFiltersChips || !resetBtn) return;

            if (activeCount > 0) {
                let chipsHtml = '';
                const filterLabels = {
                    crashType: { 'fatal': 'Fatal only', 'pedestrian': 'Ped/Cyclist' },
                    year: {},
                    time: { 'morning': 'Morning', 'midday': 'Midday', 'afternoon': 'Afternoon', 'evening': 'Evening', 'night': 'Night' },
                    day: { 'weekday': 'Weekdays', 'weekend': 'Weekends', 'mon': 'Monday', 'tue': 'Tuesday', 'wed': 'Wednesday', 'thu': 'Thursday', 'fri': 'Friday', 'sat': 'Saturday', 'sun': 'Sunday' },
                    lighting: { 'daylight': 'Daylight', 'dark': 'Dark', 'dusk': 'Dusk/Dawn' },
                    weather: { 'clear': 'Clear', 'rain': 'Rain', 'snow': 'Snow/Ice' }
                };

                Object.entries(activeFilters).forEach(([key, value]) => {
                    if (value !== 'all') {
                        const label = filterLabels[key][value] || value;
                        chipsHtml += `<span class="filter-chip">${label}</span>`;
                    }
                });

                activeFiltersChips.innerHTML = chipsHtml;
                activeFiltersChips.style.display = 'flex';
                resetBtn.disabled = false;
            } else {
                activeFiltersChips.innerHTML = '';
                activeFiltersChips.style.display = 'none';
                resetBtn.disabled = true;
            }
        }

        // Hotspots sidebar toggle
        function toggleHotspotsList() {
            const sidebar = document.getElementById('mapSidebar');
            const toggleIcon = document.getElementById('sidebarToggleIcon');

            hotspotsExpanded = !hotspotsExpanded;

            if (hotspotsExpanded) {
                sidebar.classList.remove('collapsed');
                toggleIcon.innerHTML = '&#9650;';
            } else {
                sidebar.classList.add('collapsed');
                toggleIcon.innerHTML = '&#9660;';
            }
        }

        // Hotspots sorting
        function sortHotspots() {
            const sortBy = document.getElementById('hotspotSortSelect').value;

            sortedHotspotData = [...hotspotData];

            switch(sortBy) {
                case 'crashes':
                    sortedHotspotData.sort((a, b) => b.injury_count - a.injury_count);
                    break;
                case 'fatal':
                    sortedHotspotData.sort((a, b) => b.fatal_count - a.fatal_count);
                    break;
                case 'ped':
                    sortedHotspotData.sort((a, b) => b.nonmotorist_count - a.nonmotorist_count);
                    break;
                case 'score':
                default:
                    // Already sorted by score from data
                    break;
            }

            populateHotspots();
        }

        function normalizeRoadName(name) {
            if (!name) return '';
            return name.toUpperCase().replace(/\s+NO\s+\d+/g, '').replace(/\s+[NSEW]$/g, '').replace(/-[NSEW]$/g, '').replace(/\s+/g, ' ').trim();
        }

        function findCrashesForHotspot(hotspot, radiusMeters = 150) {
            const matchedCrashes = new Set();
            const hotspotNormalized = normalizeRoadName(hotspot.road_name);
            const filteredCrashes = getFilteredCrashes();

            filteredCrashes.forEach(crash => {
                const distance = getDistance(hotspot.lat, hotspot.lng, crash.lat, crash.lng);
                if (distance <= radiusMeters) {
                    matchedCrashes.add(crash);
                    return;
                }

                const crashLocation = normalizeRoadName(crash.location);
                if (hotspotNormalized && crashLocation.includes(hotspotNormalized)) {
                    matchedCrashes.add(crash);
                }
            });

            return Array.from(matchedCrashes).sort((a, b) => {
                return new Date(b.date + ' ' + b.time) - new Date(a.date + ' ' + a.time);
            });
        }

        function getDistance(lat1, lng1, lat2, lng2) {
            const R = 6371000;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function flyToCrash(crashId) {
            crashId = String(crashId);
            const crash = crashMarkersIndex[crashId];
            if (!crash) return;

            const marker = crashMarkers.find(m => String(m.crashId) === crashId);
            if (!marker) return;

            if (highlightCircle) {
                highlightCircle.setStyle({ fillOpacity: 0.1, opacity: 0.3 });
            }

            map.flyTo([crash.lat, crash.lng], 18, { duration: 0.9 });

            setTimeout(() => {
                marker.openPopup();
            }, 1000);
        }

        function switchToExploreTab() {
            const exploreNavItem = document.querySelector('.nav-item[data-section="explore"]');
            if (exploreNavItem && !exploreNavItem.classList.contains('active')) {
                exploreNavItem.click();
            }
        }

        function renderCrashList(hotspot, crashes, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            if (!currentCrashLists[containerId]) {
                currentCrashLists[containerId] = {
                    allCrashes: crashes,
                    displayCount: 10,
                    sortBy: 'recent'
                };
            }

            const state = currentCrashLists[containerId];
            state.allCrashes = crashes;

            function render() {
                if (crashes.length === 0) {
                    container.innerHTML = `
                        <div style="padding: 12px; color: #666; font-size: 12px; font-style: italic;">
                            No crashes found matching current filters.
                        </div>
                    `;
                    return;
                }

                let sortedCrashes = [...crashes];
                if (state.sortBy === 'severity') {
                    sortedCrashes.sort((a, b) => {
                        const severityOrder = { 'fatal': 3, 'pedestrian': 2, 'cyclist': 2, 'injury': 1 };
                        const aScore = (severityOrder[a.severity] || 0) + (severityOrder[a.type] || 0);
                        const bScore = (severityOrder[b.severity] || 0) + (severityOrder[b.type] || 0);
                        return bScore - aScore;
                    });
                } else if (state.sortBy === 'pedcyclist') {
                    sortedCrashes.sort((a, b) => {
                        const aIsPed = (a.type === 'pedestrian' || a.type === 'cyclist') ? 1 : 0;
                        const bIsPed = (b.type === 'pedestrian' || b.type === 'cyclist') ? 1 : 0;
                        return bIsPed - aIsPed;
                    });
                }

                const displayCrashes = sortedCrashes.slice(0, state.displayCount);
                const remaining = sortedCrashes.length - state.displayCount;

                let html = `
                    <div class="crash-list-header">
                        <div style="font-size: 11px; color: #666; font-weight: 500;">
                            ${crashes.length} crash${crashes.length !== 1 ? 'es' : ''}
                        </div>
                        <select class="sort-select" id="sort-${containerId}">
                            <option value="recent" ${state.sortBy === 'recent' ? 'selected' : ''}>Recent</option>
                            <option value="severity" ${state.sortBy === 'severity' ? 'selected' : ''}>Severity</option>
                            <option value="pedcyclist" ${state.sortBy === 'pedcyclist' ? 'selected' : ''}>Ped/cyclist</option>
                        </select>
                    </div>
                `;

                displayCrashes.forEach(crash => {
                    const color = getMarkerColor(crash);
                    const crashClasses = ['crash-row'];
                    if (crash.severity === 'fatal') crashClasses.push('fatal');
                    if (crash.type === 'pedestrian') crashClasses.push('pedestrian');
                    if (crash.type === 'cyclist') crashClasses.push('cyclist');

                    html += `
                        <div class="${crashClasses.join(' ')}" data-crash-id="${crash.id}">
                            <div class="crash-severity ${crash.severity} ${crash.type}">
                                ${crash.severity.toUpperCase()}${crash.type !== 'vehicle' ? ' - ' + crash.type.toUpperCase() : ''}
                            </div>
                            <div class="crash-date">${crash.date} at ${crash.time}</div>
                            <div class="crash-details">${crash.weather} &bull; ${crash.light}</div>
                        </div>
                    `;
                });

                if (remaining > 0) {
                    html += `
                        <button class="show-more-btn" id="show-more-${containerId}">
                            Show ${Math.min(10, remaining)} more (${remaining} left)
                        </button>
                    `;
                }

                container.innerHTML = html;

                container.querySelectorAll('.crash-row').forEach(row => {
                    row.addEventListener('click', () => {
                        switchToExploreTab();
                        setTimeout(() => {
                            flyToCrash(row.getAttribute('data-crash-id'));
                        }, 100);
                    });
                });

                const sortSelect = document.getElementById(`sort-${containerId}`);
                if (sortSelect) {
                    sortSelect.addEventListener('change', (e) => {
                        e.stopPropagation();
                        state.sortBy = e.target.value;
                        render();
                    });
                }

                const showMoreBtn = document.getElementById(`show-more-${containerId}`);
                if (showMoreBtn) {
                    showMoreBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        state.displayCount += 10;
                        render();
                    });
                }
            }

            render();
        }

        function populateHotspots() {
            const container = document.getElementById('hotspotsList');
            if (!container) return;

            container.innerHTML = '';

            sortedHotspotData.forEach((hotspot, index) => {
                const div = document.createElement('div');
                div.className = 'hotspot-item';
                div.setAttribute('data-hotspot-index', index);

                const hasFatal = hotspot.fatal_count > 0;
                const hasPedCyclist = hotspot.nonmotorist_count > 0;

                let badgesHtml = '';
                if (hasFatal) badgesHtml += '<span class="fatal-indicator">FATAL</span>';
                if (hasPedCyclist) badgesHtml += '<span class="ped-cyclist-indicator">PED/CYCLIST</span>';

                div.innerHTML = `
                    <div class="hotspot-header">
                        <div class="hotspot-name">${index + 1}. ${hotspot.road_name}</div>
                        <div class="hotspot-badges">${badgesHtml}</div>
                    </div>
                    <div class="hotspot-stats">
                        ${hotspot.injury_count} injuries${hotspot.fatal_count > 0 ? ', ' + hotspot.fatal_count + ' fatal' : ''}${hotspot.nonmotorist_count > 0 ? ', ' + hotspot.nonmotorist_count + ' ped/cyclist' : ''}
                    </div>
                    <div class="crash-detail-panel" id="crash-detail-${index}" style="display: none;">
                        <button class="toggle-crashes-btn" data-hotspot-index="${index}">
                            <span>View crashes</span>
                            <span class="toggle-icon">&#9660;</span>
                        </button>
                        <div id="crash-list-${index}" style="display: none; margin-top: 10px;"></div>
                    </div>
                `;

                div.addEventListener('click', (e) => {
                    if (e.target.closest('.toggle-crashes-btn')) return;
                    if (e.target.closest('.crash-row')) return;
                    if (e.target.closest('.sort-select')) return;
                    if (e.target.closest('.show-more-btn')) return;
                    selectHotspot(hotspot, index);
                });

                container.appendChild(div);
            });

            document.querySelectorAll('.toggle-crashes-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const index = btn.getAttribute('data-hotspot-index');
                    const crashList = document.getElementById(`crash-list-${index}`);
                    const icon = btn.querySelector('.toggle-icon');

                    if (crashList.style.display === 'none') {
                        const hotspot = sortedHotspotData[index];
                        const crashes = findCrashesForHotspot(hotspot);
                        currentCrashLists[`crash-list-${index}`] = null;
                        renderCrashList(hotspot, crashes, `crash-list-${index}`);
                        crashList.style.display = 'block';
                        icon.innerHTML = '&#9650;';
                    } else {
                        crashList.style.display = 'none';
                        icon.innerHTML = '&#9660;';
                    }
                });
            });
        }

        function selectHotspot(hotspot, index) {
            switchToExploreTab();

            setTimeout(() => {
                map.closePopup();

                if (highlightCircle) {
                    map.removeLayer(highlightCircle);
                    highlightCircle = null;
                }

                document.querySelectorAll('.hotspot-item').forEach(item => {
                    item.classList.remove('selected');
                });

                const hotspotElement = document.querySelector(`.hotspot-item[data-hotspot-index="${index}"]`);
                if (hotspotElement) {
                    hotspotElement.classList.add('selected');
                }

                const hasFatal = hotspot.fatal_count > 0;

                map.flyTo([hotspot.lat, hotspot.lng], 16, { duration: 1.0 });

                setTimeout(() => {
                    highlightCircle = L.circle([hotspot.lat, hotspot.lng], {
                        radius: 100,
                        fillColor: hasFatal ? '#c62828' : '#ef6c00',
                        fillOpacity: 0.25,
                        stroke: true,
                        color: hasFatal ? '#c62828' : '#ef6c00',
                        weight: 2
                    }).addTo(map);

                    highlightCircle.bringToFront();

                    highlightCircle.bindPopup(`
                        <div style="font-family: system-ui; text-align: center; padding: 4px;">
                            <strong style="font-size: 15px; display: block; margin-bottom: 6px;">${hotspot.road_name}</strong>
                            <div style="font-size: 14px; color: #666; margin-bottom: 4px;">${hotspot.injury_count} injury crashes</div>
                            ${hasFatal ? '<div style="color: #c62828; font-weight: 600;">' + hotspot.fatal_count + ' fatal</div>' : ''}
                            ${hotspot.nonmotorist_count > 0 ? '<div style="color: #ef6c00; font-weight: 500;">' + hotspot.nonmotorist_count + ' pedestrian/cyclist</div>' : ''}
                        </div>
                    `).openPopup();

                    document.querySelectorAll('.crash-detail-panel').forEach(c => c.style.display = 'none');
                    const detailContainer = document.getElementById(`crash-detail-${index}`);
                    if (detailContainer) {
                        detailContainer.style.display = 'block';
                    }

                    currentSelectedHotspot = index;
                }, 400);
            }, 100);
        }

        // QA functions
        function runSmokeTests() {
            testResults = {};
            const timestamp = new Date().toLocaleString();
            document.getElementById('qaTimestamp').textContent = timestamp;

            testResults.tabNavigation = document.querySelectorAll('.nav-item').length >= 4;
            testResults.mapInitialized = map !== null && map !== undefined;
            testResults.tilesAttempted = true;
            testResults.crashDataParsed = Array.isArray(crashData) && crashData.length > 0;
            testResults.markersCreated = crashMarkers.length > 0;
            testResults.hotspotsRendered = document.querySelectorAll('.hotspot-item').length > 0;
            testResults.filterLogic = (() => {
                const allCrashes = crashData.length;
                const fatalCrashes = crashData.filter(c => c.severity === 'fatal').length;
                const pedCrashes = crashData.filter(c => c.type === 'pedestrian' || c.type === 'cyclist').length;
                return allCrashes > 0 && (fatalCrashes > 0 || pedCrashes > 0);
            })();

            testResults.yearFilterWorks = (() => {
                const oldYear = activeFilters.year;
                activeFilters.year = '2022';
                const filtered2022 = getFilteredCrashes();
                activeFilters.year = '2023';
                const filtered2023 = getFilteredCrashes();
                activeFilters.year = oldYear;
                return filtered2022.length !== filtered2023.length && filtered2022.length > 0 && filtered2023.length > 0;
            })();

            testResults.dayFilterWorks = (() => {
                const oldDay = activeFilters.day;
                activeFilters.day = 'weekday';
                const filteredWeekday = getFilteredCrashes();
                activeFilters.day = 'weekend';
                const filteredWeekend = getFilteredCrashes();
                activeFilters.day = oldDay;
                return filteredWeekday.length !== filteredWeekend.length && filteredWeekday.length > 0 && filteredWeekend.length > 0;
            })();

            testResults.heatmapBuilds = true;
            testResults.hotspotClickTriggersFlyTo = typeof selectHotspot === 'function';
            testResults.crashRowClickTriggersFlyTo = typeof flyToCrash === 'function';
            testResults.paginationWorks = typeof renderCrashList === 'function';

            displayTestResults();
        }

        function displayTestResults() {
            const testsContainer = document.getElementById('qaTests');
            let html = '';

            const tests = [
                { key: 'tabNavigation', label: 'Tab navigation binding' },
                { key: 'mapInitialized', label: 'Map initialized' },
                { key: 'tilesAttempted', label: 'Tile layer attempted' },
                { key: 'crashDataParsed', label: 'crashData parsed' },
                { key: 'markersCreated', label: 'Markers created' },
                { key: 'hotspotsRendered', label: 'Hotspots rendered' },
                { key: 'filterLogic', label: 'Filter logic functional' },
                { key: 'yearFilterWorks', label: 'Year filter working' },
                { key: 'dayFilterWorks', label: 'Day of week filter working' },
                { key: 'heatmapBuilds', label: 'Heatmap builds' },
                { key: 'hotspotClickTriggersFlyTo', label: 'Hotspot click triggers flyTo' },
                { key: 'crashRowClickTriggersFlyTo', label: 'Crash click triggers flyTo' },
                { key: 'paginationWorks', label: 'Pagination implemented' }
            ];

            tests.forEach(test => {
                const status = testResults[test.key] ? 'pass' : 'fail';
                html += `<div class="qa-test ${status}">${test.label}</div>`;
            });

            testsContainer.innerHTML = html;
        }

        function toggleQAPanel() {
            const content = document.getElementById('qaContent');
            content.classList.toggle('show');
        }

        function copyDiagnostics() {
            const results = Object.entries(testResults)
                .map(([key, value]) => `${key}: ${value ? 'PASS' : 'FAIL'}`)
                .join('\n');

            const text = `Stamford Safety Explorer ${metaData.version || 'Unknown'}\nLoaded: ${document.getElementById('qaTimestamp').textContent}\n\n${results}`;

            navigator.clipboard.writeText(text).then(() => {
                alert('Diagnostics copied to clipboard');
            }).catch(() => {
                alert('Failed to copy. Results:\n\n' + text);
            });
        }

        // Main initialization
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                await loadData();

                const validationErrors = validateData();
                if (validationErrors.length > 0) {
                    throw new Error('Data validation failed: ' + validationErrors.join(', '));
                }

                buildCrashIndex();
                initializeMap();
                setupNavigation();
                setupControls();
                populateHotspots();
                filterCrashes(currentFilter);

                hideLoading();

                if (isDebugMode) {
                    setTimeout(() => {
                        runSmokeTests();
                    }, 500);
                }

            } catch (error) {
                showError('initialization', error);
            }
        });
    </script>
</body>
</html>
